window.changeCartQuantity = function (sku, quantity) {
    var cartItems = {{ cartItem|json_encode()|raw }};
    var addToCartLayer = {{ addToCartLayer|json_encode()|raw }};
    var removeFromCartLayer = {{ removeFromCartLayer|json_encode()|raw }};
    var product = cartItems[sku];
    var eventLayer;

    var layerGA4 = {
        event: "add_to_card",
        ecommerce_ga4: {
            items: []
        }
    };

    if (quantity > product['quantity']) {
        product.quantity = quantity - product['quantity'];
        addToCartLayer['ecommerce']['add']['products'] = [product];
        eventLayer = addToCartLayer;

        layerGA4.event = 'add_to_card';
        layerGA4.ecommerce.items.push(product);
    }

    if (product['quantity'] > quantity) {
        product.quantity = product['quantity'] - quantity;
        removeFromCartLayer['ecommerce']['remove']['products'] = [product];
        eventLayer = removeFromCartLayer;

        layerGA4.event = 'remove_from_cart';
        layerGA4.ecommerce.items.push(product);
    }

    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push(eventLayer);
    window.dataLayer.push({ ecommerce_ga4: null });
    window.dataLayer.push(layerGA4);
}
